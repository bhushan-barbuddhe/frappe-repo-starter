# .github/workflows/init-frappe-app.yml
name: Initialize Frappe App

on:
  push:
    branches:
      - main
      - master
  create:

jobs:
  create-app:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'create' || 
      (github.event_name == 'push' && github.run_number == 1)
    
    steps:
      - name: Generate GitHub App Token
        id: generate-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.DHWANI_RELEASE_BOT_APP_ID }}
          private_key: ${{ secrets.DHWANI_RELEASE_BOT_PRIVATE_KEY }}
          
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}
          persist-credentials: true
          
      - name: Check if Already Initialized
        id: check
        run: |
          APP_NAME=$(echo "${{ github.event.repository.name }}" | tr '-' '_' | tr '[:upper:]' '[:lower:]')
          
          if [ -d "$APP_NAME" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "App already initialized, skipping..."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up Python
        if: steps.check.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install expect
        if: steps.check.outputs.skip != 'true'
        run: sudo apt-get install -y expect
      
      - name: Install Frappe Bench
        if: steps.check.outputs.skip != 'true'
        run: pip install frappe-bench
          
      - name: Initialize Bench
        if: steps.check.outputs.skip != 'true'
        run: |
          bench init --skip-redis-config-generation --skip-assets --frappe-branch develop frappe-bench
          
      - name: Create New App
        if: steps.check.outputs.skip != 'true'
        run: |
          cd frappe-bench
          
          # Derive app_name from repo name (snake_case)
          APP_NAME=$(echo "${{ github.event.repository.name }}" | tr '-' '_' | tr '[:upper:]' '[:lower:]')
          
          # Derive app_title from repo name (Title Case)
          APP_TITLE=$(echo "${{ github.event.repository.name }}" | tr '-' ' ' | tr '_' ' ' | sed 's/.*/\L&/' | sed 's/[a-z]*/\u&/g')
          
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "APP_TITLE=$APP_TITLE" >> $GITHUB_ENV
          
          export APP_NAME APP_TITLE
          
          # Create app using expect to handle interactive prompts
          expect << 'EXPECT_SCRIPT'
          set timeout 120
          set app_name $env(APP_NAME)
          set app_title $env(APP_TITLE)
          
          spawn bench new-app --no-git $app_name
          
          expect "App Title*"
          send "$app_title\r"
          
          expect "App Description*"
          send "$app_title - Custom Frappe Application\r"
          
          expect "App Publisher*"
          send "DHWANI RIS\r"
          
          expect "App Email*"
          send "frappeteam@dhwaniris.com\r"
          
          expect "App License*"
          send "mit\r"
          
          expect "Create GitHub Workflow*"
          send "N\r"
          
          expect "Branch Name*"
          send "develop\r"
          
          expect eof
          EXPECT_SCRIPT
          
      - name: Copy App to Repo Root
        if: steps.check.outputs.skip != 'true'
        run: |
          APP_NAME=${{ env.APP_NAME }}
          
          # Copy only the app folder contents to repo root
          cp -r "frappe-bench/apps/$APP_NAME/." ./
          
          # Remove the frappe-bench folder completely
          rm -rf frappe-bench
          
          # Verify what we have
          echo "=== Repo contents after copy ==="
          ls -la
          
      - name: Delete Init Workflow
        if: steps.check.outputs.skip != 'true'
        run: |
          rm -f .github/workflows/init-frappe-app.yml
          rmdir .github/workflows 2>/dev/null || true
          rmdir .github 2>/dev/null || true
          
      - name: Download Template Files from frappe-standard-template
        if: steps.check.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          git clone --depth 1 https://x-access-token:${GH_TOKEN}@github.com/dhwani-ris/frappe-workflows.git template-repo
          
          # Copy .github folder
          cp -r template-repo/.github .
          
          # Copy docs folder
          cp -r template-repo/docs .
          
          # Copy commitlint config
          cp template-repo/commitlint.config.js .
          
          # Copy .releaserc
          cp template-repo/.releaserc .
          
          # Update .pre-commit-config.yaml
          if [ -f template-repo/.pre-commit-config.yaml ]; then
            cp template-repo/.pre-commit-config.yaml .
          fi
          
          # Cleanup template repo
          rm -rf template-repo
          
          # Verify final structure
          echo "=== Final repo contents ==="
          ls -la
          
      - name: Commit and Push
        if: steps.check.outputs.skip != 'true'
        run: |
          git config user.name "dhwani-release-bot[bot]"
          git config user.email "dhwani-release-bot[bot]@users.noreply.github.com"
          git add -A
          git commit -m "ðŸš€ Initialize Frappe app: ${{ env.APP_NAME }}"
          git push
          
      - name: Summary
        if: steps.check.outputs.skip != 'true'
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âœ… Frappe App Initialized Successfully!
          
          | Property | Value |
          |----------|-------|
          | **App Name** | \`${{ env.APP_NAME }}\` |
          | **App Title** | ${{ env.APP_TITLE }} |
          | **Publisher** | DHWANI RIS |
          
          ### ðŸ“ Files Added:
          
          **From bench new-app:**
          - \`${{ env.APP_NAME }}/\` - App module
          - \`pyproject.toml\` - Python project config
          - \`license.txt\` - MIT License
          
          **From frappe-standard-template:**
          - \`.github/\` - Workflows, issue templates, PR templates
          - \`docs/\` - Documentation structure
          - \`commitlint.config.js\` - Commit message linting
          - \`.releaserc\` - Semantic release config
          - \`.pre-commit-config.yaml\` - Pre-commit hooks
          
          ### ðŸš€ Next Steps:
          
          \`\`\`bash
          bench get-app git@github.com:${{ github.repository }}.git
          bench --site yoursite install-app ${{ env.APP_NAME }}
          \`\`\`
          EOF
